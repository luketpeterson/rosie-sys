FROM centos:8
ARG branch

RUN yum -y update && yum install -y epel-release

# The version of git distributed with Centos7 is old (1.8.3) and does
# not support the --depth option in 'git submodule update --checkout --depth 1'.
# Use this sequence of yum commands to fix this situation:
#RUN yum -y remove git*
#RUN yum -y install https://centos7.iuscommunity.org/ius-release.rpm
#RUN yum -y install git2u-all
# And also comment out this yum command, which works fine on Centos8:
RUN yum install -y git

RUN yum install -y gcc make readline readline-devel libbsd libbsd-devel

# This COPY is designed to trigger re-running the git clone when the repo changes:
COPY githead-$branch /opt/githead-$branch
RUN git clone --depth 1 --branch $branch https://gitlab.com/rosie-pattern-language/rosie.git /opt/rosie

WORKDIR /opt/rosie
RUN make LUADEBUG=1
RUN make test
RUN make clean; make
RUN make install

RUN rosie version
RUN rosie match all.things test/resolv.conf

RUN uname -a
RUN cat /etc/centos-release
