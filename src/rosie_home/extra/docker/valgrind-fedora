FROM fedora:32
ARG branch

RUN dnf -y update && dnf install -y \
  gcc \
  git \
  make \
  findutils \
  readline-devel \
  valgrind \
  libbsd \
  libbsd-devel

# Must symlink or copy these test files into the docker directory
COPY syslog100k /opt/data/
COPY syslog-2018-09-05.rpl /opt/data/

# Needed in case we build rosie with ASAN=1:
RUN dnf install -y libasan libubsan

# This COPY is designed to trigger re-running the git clone when the repo changes.
COPY githead-$branch /opt/githead-$branch

WORKDIR /opt
RUN git clone --recursive --depth 1 --branch $branch https://gitlab.com/rosie-pattern-language/rosie.git /opt/rosie

WORKDIR /opt/rosie
RUN make LUADEBUG=1
RUN make test
RUN make install

# A small test to ensure that the installed rosie will execute:
RUN rosie version
# A full test, which is possible because we installed the LUADEBUG=1 version:
RUN make test ROSIE=/usr/local/bin/rosie

# Here is one simple invocation of valgrind, just to make sure it
# works.  Get an interactive shell to this container to run more tests.
RUN valgrind --leak-check=full rosie -f /opt/data/syslog-2018-09-05.rpl match -o byte syslog /opt/data/syslog100k >/dev/null

RUN uname -a
RUN cat /etc/fedora-release
