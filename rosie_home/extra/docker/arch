FROM archlinux:20200407
ARG branch

RUN pacman -Syy --noconfirm
RUN pacman -S   --noconfirm archlinux-keyring
RUN pacman -Su  --noconfirm

RUN pacman -S --noconfirm make
RUN pacman -S --noconfirm gcc
RUN pacman -S --noconfirm readline
RUN pacman -S --noconfirm libbsd
RUN pacman -S --noconfirm git

# This COPY is designed to trigger re-running the git clone when the repo changes.
COPY githead-$branch /opt/githead-$branch
RUN git clone --depth 1 --branch $branch https://gitlab.com/rosie-pattern-language/rosie.git /opt/rosie

WORKDIR /opt/rosie
RUN make LUADEBUG=1
RUN make test
RUN make clean; make
RUN make install

# A couple of small tests to ensure the installed copy functions:
RUN rosie version
RUN rosie match all.things test/resolv.conf





